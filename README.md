# Pumpkin (Trello clone)

## by team RPO

- [Стремин Валентин](https://github.com/supchaser)

- [Жуков Георгий](https://github.com/dedxyk594)

- [Сафронов Константин](https://github.com/kosafronov)

Менторы:

- [Тарасов Артём](https://github.com/tarasovxx) - Backend

- [Фикслер Леонид](https://github.com/reddiridabl666) - Backend

- [Алёхин Владислав](https://github.com/3kybika) - СУБД

[Репозиторий фронтенда](https://github.com/frontend-park-mail-ru/2024_2_RPO)

[Ссылка на деплой](https://kanban-pumpkin.ru)

[Ссылка на Swagger](https://dedxyk594.github.io/swagger_ui_RPO/index.html)

## Стандарты разработки

- Все комментарии на русском языке
- Все логи на английском языке
- У аббревиатур все буквы в одном регистре: ~~`sessionId`~~ `sessionID`
- В импортах между нашими пакетами и стандартными должна быть пустая строка

## Запуск сервера

### Docker

Сначала надо убедиться, что в трёх файлах используется не CRLF, а LF:

* `/database/postgres/start-postgres.sh`
* `/database/postgres/certgen.sh`
* `/database/redis/start-redis.sh`

Далее надо сгенерировать сертификаты для Postgres вызовом скрипта `/database/postgres/certgen.sh`. Вызывать его надо в той директории, где находится скрипт. Возможно, надо поставить OpenSSL. Этот скрипт сгенерирует самоподписанные сертификаты.

Надо оформить файл `.env`. Пример:

```
CORS_ORIGIN = https://example.com

# Эту переменную надо задавать, если Вам надо создать миграции с помощью Atlas
TEST_DATABASE_URL = postgresql://3kybika:12345678@localhost:5432/migrate_gen_db?sslmode=disable
```

Потом можно запускать сами сервисы через Docker. Команда:

```sh
make build_all -j && docker compose up --build
```

Эта команда на хост-машине соберёт все бинари и будет исполнять их на докерах.

Это ещё не все шаги: мы не накатили миграции. Для миграций надо зайти в контейнер `auth_service` и там вызвать команду `make migrate-up`.
Имейте в виду, что auth_service, если не смог подключиться к PostgreSQL, ждёт 100 секунд, чтобы мы смогли накатить миграции и создать базу данных.
Также имейте в виду, что контейнер с PostgreSQL при первом запуске запускает наш самописный скрипт инициализации, поэтому не спешите выключать контейнер, дождитесь, пока база создастся.

> [!CAUTION]
> Часто бывает, что в volume, где хранится сокет PostgreSQL, слетают права. Тогда postgres завершает свою работу, и бэк ложится. Если такой случай произошёл, надо удалить все контейнеры, удалить volume `pumpkin-postgres-socket` и заново поднять docker compose

### Запуск тестов

Надо сделать всё, что нужно для запуска сервера, но вместо `make run` запустить `make test`. Чтобы получить информацию о покрытии, надо запустить `make coverage`

## Схема базы данных

Актуальная модель данных находится в директории `database/schema.sql`

Для создания миграций используется программа [Atlas](https://atlasgo.io). Для применения используется [go-migrate](https://github.com/golang-migrate/migrate)

После изменения модели данных надо сгенерировать миграцию. Чтобы её сгенерировать, понадобится dev-база (и развёрнутый Postgres), потому что [без него Atlas не создаст миграции](https://atlasgo.io/atlas-schema/sql#dev-database).

URL dev-базы надо указать в файлe `.env` по имени `TEST_DATABASE_URL`. Эта база должна быть пустая; после работы atlas очистит всё, что он насоздавал. У пользователя должны быть все права на базу, а также права на создание ролей

Миграцию надо генерировать командой `make make-migrations`. Имя миграции не должно содержать пробелы, должно быть типа `add_tags_table`

Применять миграции надо командой `make migrate-up`. Команда интерактивно попросит логин и пароль от root-пользователя. На проде надо делать миграции пользователем `postgres`. Применение миграций доступно только из контейнера auth.
